{% extends 'myapp/base.html' %}

{% block title%}Feed{% endblock %}

{% block extra_css%}
    {% load static %}
    <link href="{% static 'profile-feed.css' %}" rel="stylesheet">
{% endblock %}

{% block navigation %}

  <li><button class="white-btn" onclick="location.href='/profile'">PROFILE</button></li>

{% endblock %}

{% block content %}

<div class="feed_wrapper">
  <div class="feed_post_container">
      {% for post in posts %}
          <div class="post">
              <div class="post-author">
                  <a href="/profile/{{ post.author.username }}" class="author-avatar">
                      <img src="{{ post.author.profile.avatar.url|default:'/static/images/default-avatar.png' }}" alt="Author Avatar">
                  </a>
                  <a href="/profile/{{ post.author.username }}" class="author-name">{{ post.author.username }}</a>
              </div>
              <p>{{ post.text }}</p>
          <div>
          <div class="tags-container">
                {% for tag in post.tags.all %}
                    <span><a href="">{{ tag.name }}</a></span>
                {% empty %}
                    <p></p>
                {% endfor %}
          </div>
          </div>
            {% if post.images.all %}

            {% for image in post.images.all %}
                <img src="{{ image.image.url }}" alt="Post Image" />
            {% endfor %}
            {% endif %}
              <div class="post-footer">
                  <p>{{ post.created_at }}</p>
                  <div class="like-button-container">
                      <button class="like-button" onclick="likePost({{ post.id }}, this)">
                          <img src="/static/images/like.png" alt="Like" class="unliked" {% if request.user in post.likes.all %}style="display: none;"{% endif %}>
                          <img src="/static/images/liked.png" alt="Liked" class="liked" {% if request.user not in post.likes.all %}style="display: none;"{% endif %}>
                      </button>
                      <a href="#" class="likes-count" onclick="showLikes({{ post.id }})">{{ post.likes.count }}</a>
                  </div>
              </div>
          </div>
      {% endfor %}
  </div>
</div>
<script>
    function likePost(postId, button) {
        fetch(`/like_post/${postId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
        })
        .then(response => response.json())
        .then(data => {
            button.classList.toggle('liked');
            const likesCount = button.nextElementSibling;
            likesCount.textContent = data.likes_count;
            if (button.classList.contains('liked')) {
                button.querySelector('.unliked').style.display = 'none';
                button.querySelector('.liked').style.display = 'block';
            } else {
                button.querySelector('.unliked').style.display = 'block';
                button.querySelector('.liked').style.display = 'none';
            }
        });
    }
</script>
{% endblock %}
