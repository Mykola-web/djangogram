{% extends 'myapp/base.html' %}

{% block title%}Profile{% endblock %}

{% block extra_css%}
    {% load static %}
    <link href="{% static 'profile-feed.css' %}" rel="stylesheet">
{% endblock %}

{% block navigation %}
    {% if is_own_profile %}
    <li><button class="white-btn" onclick="location.href='/profile/edit'">EDIT PROFILE</button></li>
	{% else %}
	<li><button class="white-btn" onclick="location.href='/profile/'">MY PROFILE</button></li>
	{% endif %}
{% endblock %}

{% block content %}
	<div class="profile_wrapper">
		<div class="profile-card">
			    <div class="avatar-container">
						{% if profile_owner.profile.avatar %}
							<img class="avatar" src="{{ profile_owner.profile.avatar.url }}" alt="Avatar">
						{% else %}
							<img class="avatar" src="https://res.cloudinary.com/dnctmhqcl/image/upload/default_avatar_gruuhe" alt="Default Avatar">
						{% endif %}
<!--					<img src="{{ user.profile.avatar.url|default:'/static/images/default-avatar.png' }}" alt="User Avatar" class="avatar">-->
				</div>
				<div class="user-info">
					<h2 class="username">{{ profile_owner.username }}</h2>
					<p class="bio">{{ profile_owner.profile.bio | default:'Some profile text' }}</p>
				</div>
		</div>
		<div>
			<form method="post" action="{% url 'profile' profile_owner.username%}">
				{% csrf_token %}
<!--				<button class="white-btn" type="submit">SUBSCRIBE</button>-->
				{% if not is_own_profile %}
					{% if is_subscribed %}
						<button type="submit" class="btn btn-danger">UNSUBSCRIBE</button>
					{% else %}
						<button type="submit" class="btn btn-primary">SUBSCRIBE</button>
					{% endif %}
				{% endif %}
			</form>
		</div>
		<div class="posts-container">
			{% for post in posts %}
				<div class="post">
				  <div class="post-author">
					  <a href="/profile/{{ post.author.username }}" class="author-avatar">
						{% if post.author.profile.avatar %}
							<img src="{{ post.author.profile.avatar.url }}" alt="Avatar">
						{% else %}
							<img src="{% static 'images/default_avatar.jpg' %}" alt="Default Avatar">
						{% endif %}
					  </a>
					  <a href="/profile/{{ post.author.username }}" class="author-name">{{ post.author.username }}</a>
				  </div>
				  <p>{{ post.text }}</p>
				  <div class="tags-container">
						{% for tag in post.tags.all %}
							<span><a href="">{{ tag.name }}</a></span>
						{% empty %}
							<p></p>
						{% endfor %}
				  </div>
				  {% if post.images.all %}
				  {% for image in post.images.all %}
					<img src="{{ image.image.url }}" alt="Post Image">
				  {% endfor %}
				  {% endif %}
					<div class="post-footer">
						<p>{{ post.created_at }}</p>
						<div class="like-button-container">
							<button class="like-button" onclick="likePost({{ post.id }}, this)">
								<img src="/static/images/like.png" alt="Like" class="unliked" {% if request.user in post.likes.all %}style="display: none;"{% endif %}>
								<img src="/static/images/liked.png" alt="Liked" class="liked" {% if request.user not in post.likes.all %}style="display: none;"{% endif %}>
							</button>
							<a href="#" class="likes-count" onclick="showLikes({{ post.id }})">{{ post.likes.count }}</a>
						</div>
					</div>
				</div>
			{% endfor %}
		</div>
	</div>
	<script>
		function likePost(postId, button) {
			fetch(`/like_post/${postId}/`, {
				method: 'POST',
				headers: {
					'X-CSRFToken': '{{ csrf_token }}',
					'Content-Type': 'application/json'
				},
			})
			.then(response => response.json())
			.then(data => {
				button.classList.toggle('liked');
				const likesCount = button.nextElementSibling;
				likesCount.textContent = data.likes_count;
				if (button.classList.contains('liked')) {
					button.querySelector('.unliked').style.display = 'none';
					button.querySelector('.liked').style.display = 'block';
				} else {
					button.querySelector('.unliked').style.display = 'block';
					button.querySelector('.liked').style.display = 'none';
				}
			});
		}
	</script>
{% endblock %}
